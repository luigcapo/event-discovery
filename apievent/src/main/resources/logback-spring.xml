<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!-- Importation des utilitaires Spring Boot -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- Propriété pour le nom de l'application, récupérée depuis application.properties -->
    <springProperty scope="context" name="appName" source="spring.application.name" defaultValue="my-app"/>

    <!-- ================================================================== -->
    <!-- Appender pour la CONSOLE (pour l'env de dev)             -->
    <!-- ================================================================== -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <!-- Format de log lisible pour les humains -->
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            <charset>utf8</charset>
        </encoder>
    </appender>

    <!-- ================================================================== -->
    <!-- Appender JSON pour OpenTelemetry (pour les environnements déployés)-->
    <!-- ================================================================== -->
    <appender name="JSON_OTEL" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/app.json</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- Rotation quotidienne des fichiers de log -->
            <fileNamePattern>logs/app-log-%d{yyyy-MM-dd}.json.gz</fileNamePattern>
            <!-- Garde 30 jours d'historique, compresse les anciens fichiers -->
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <!-- Ajout de champs personnalisés pour correspondre au standard OTel -->
            <timestamp>
                <fieldName>timestamp</fieldName>
                <timeZone>UTC</timeZone>
                <pattern>yyyy-MM-dd'T'HH:mm:ss.SSS'Z'</pattern>
            </timestamp>
            <logLevel>
                <fieldName>level</fieldName>
            </logLevel>
            <loggerName>
                <fieldName>logger</fieldName>
            </loggerName>
            <threadName>
                <fieldName>thread</fieldName>
            </threadName>
            <message/>
            <stackTrace>
                <fieldName>stack_trace</fieldName>
            </stackTrace>
            <mdc>
                <includeMdcKeyName>traceId</includeMdcKeyName>
                <includeMdcKeyName>spanId</includeMdcKeyName>
            </mdc>
            <!-- Ajout du nom du service, essentiel pour le monitoring -->
            <customFields>
                <json>
                    {
                    "service.name": "${appName}"
                    }
                </json>
            </customFields>
        </encoder>
    </appender>

    <!-- ================================================================== -->
    <!-- Configuration par profil Spring                                    -->
    <!-- ================================================================== -->

    <!-- Par défaut  on logue en JSON. -->
    <root level="INFO">
        <appender-ref ref="JSON_OTEL"/>
    </root>

    <!-- Pour les profils de développement, on SURCHARGE la config par défaut -->
    <!-- pour ajouter la sortie vers la console. -->
    <springProfile name="dev, rec">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="JSON_OTEL"/>
        </root>
    </springProfile>


</configuration>
